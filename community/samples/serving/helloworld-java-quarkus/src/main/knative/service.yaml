apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: helloworld-java-quarkus
spec:
  runLatest:
    configuration:
      build:
        apiVersion: build.knative.dev/v1alpha1
        kind: Build
        spec:
          serviceAccountName: quarkus-builder
          source:
            git:
              revision: "${git.source.revision}"
              url: "${git.source.repo.url}"
          steps:
            - args:
                # Check https://github.com/redhat-developer-demos/quarkus-java-builder for more configuration options
                - /usr/local/bin/buildah.sh              
              env:
                - name: WORK_DIR
                  value: /workspace/${app.context.dir}
                - name: DESTINATION_NAME
                  value: ${app.container.image}
                # uncomment this if you want to build Quarkus in JVM mode
                # - name: MVN_CMD_ARGS
                  # value: "clean -DskipTests install"
              image: quay.io/rhdevelopers/quarkus-java-builder:graal-1.0.0-rc15
              name: docker-push
              # needed for buildah builds to be running as containers
              securityContext:
                capabilities:
                  add: ["SYS_ADMIN"]
              volumeMounts:
                - mountPath: /root/.m2
                  name: m2-cache
                # needed for buildah to store its built containers
                - mountPath: /var/lib/containers
                  name: buildah-cache
              workingDir: /workspace/${app.context.dir}
          timeout: 60m
          volumes:
            - name: m2-cache
              emptyDir: {}
            - name: buildah-cache
              emptyDir: {}
      revisionTemplate:
        metadata:
          labels:
            app: helloworld-java-quarkus
        spec:
          container:
            image: ${app.container.image}
